name: CI/CD

on:
  push:
    branches: ["main", "develop"]

permissions:
  contents: read

jobs:
  ci-build:
    name: ğŸ”§ CI - Build & Docker Push
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE: ${{ github.ref == 'refs/heads/main' && format('{0}/animal-app', secrets.DOCKERHUB_ID) || format('{0}/animal-app-develop', secrets.DOCKERHUB_ID) }}

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 17 ì„¸íŒ…
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle ì„¸íŒ…
        uses: gradle/actions/setup-gradle@v4

      - name: application.yml ìƒì„±
        run: |
          mkdir -p src/main/resources
          echo "${{ secrets.APPLICATION_PROPERTIES }}" | base64 --decode > src/main/resources/application.yml

      - name: gradlew ë¹Œë“œ
        run: |
          chmod +x gradlew
          ./gradlew build -x test

      - name: ë„ì»¤í—ˆë¸Œ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_ID }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:latest .
          docker push ${{ env.DOCKER_IMAGE }}:latest


  cd-deploy:
    name: ğŸš€ CD - Deploy to GCP VM
    runs-on: ubuntu-latest
    needs: ci-build
    env:
      DOCKER_IMAGE: ${{ github.ref == 'refs/heads/main' && format('{0}/animal-app', secrets.DOCKERHUB_ID) || format('{0}/animal-app-develop', secrets.DOCKERHUB_ID) }}
      REMOTE_DIR: /home/${{ secrets.GCP_USERNAME }}/animal

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: GCP SSH í‚¤ íŒŒì¼ ìƒì„± ë° .env íŒŒì¼ ë³µì‚¬
        run: |
          # 1. SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.GCP_PRIVATEKEY }}" > gcp_key.pem
          chmod 600 gcp_key.pem

          # 2. .env íŒŒì¼ ìƒì„±
          {
            echo "DB_HOST=${{ secrets.DB_HOST }}"
            echo "DB_PORT=${{ secrets.DB_PORT }}"
            echo "DB_NAME=${{ secrets.DB_NAME }}"
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}"
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
          } > .env

          # 3. .env íŒŒì¼ GCPì— ë³µì‚¬
          echo "âœ… .env íŒŒì¼ ë³µì‚¬ ì¤‘..."
          scp -i gcp_key.pem -o StrictHostKeyChecking=no .env ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }}:${{ env.REMOTE_DIR }}/.env

      - name: mainìš© docker-compose.yml GCPì— ë³µì‚¬
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ‘‰ main ë¸Œëœì¹˜ - docker-compose.main.yml ë³µì‚¬"
          scp -i gcp_key.pem -o StrictHostKeyChecking=no docker-compose.main.yml ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }}:${{ env.REMOTE_DIR }}/docker-compose.yml

      - name: developìš© docker-compose.yml GCPì— ë³µì‚¬
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "ğŸ‘‰ develop ë¸Œëœì¹˜ - docker-compose.develop.yml ë³µì‚¬"
          scp -i gcp_key.pem -o StrictHostKeyChecking=no docker-compose.develop.yml ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }}:${{ env.REMOTE_DIR }}/docker-compose.yml

      - name: GCPì—ì„œ íŒŒì¼ í™•ì¸ ë° ë¡œì»¬ íŒŒì¼ ì •ë¦¬
        run: |
          echo "ğŸ” GCPì—ì„œ docker-compose.yml íŒŒì¼ ë‚´ìš© í™•ì¸"
          ssh -i gcp_key.pem -o StrictHostKeyChecking=no ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }} "cat ${{ env.REMOTE_DIR }}/docker-compose.yml"
          
          echo "ğŸ”‘ ë¡œì»¬ ì„ì‹œ íŒŒì¼(.env, gcp_key.pem) ì‚­ì œ"
          rm .env gcp_key.pem

      - name: GCP ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_PRIVATEKEY }}
          port: 22
          script: |
            # Docker Hubì— ì•ˆì „í•˜ê²Œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u ${{ secrets.DOCKERHUB_ID }} --password-stdin
            
            # í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¬ë°”ë¥¸ ì´ë¯¸ì§€ë¥¼ pull í•©ë‹ˆë‹¤.
            echo "ğŸ³ ìµœì‹  ì´ë¯¸ì§€ pull: ${{ env.DOCKER_IMAGE }}:latest"
            sudo docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤.
            cd ${{ env.REMOTE_DIR }}
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ë‚´ë¦½ë‹ˆë‹¤. (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
            sudo docker compose down || true
            
            # ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë„ì›ë‹ˆë‹¤.
            sudo docker compose up -d --remove-orphans
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ë¥¼ ì •ë¦¬í•˜ì—¬ ë””ìŠ¤í¬ ê³µê°„ì„ í™•ë³´í•©ë‹ˆë‹¤.
            sudo docker image prune -f
            
            echo "âœ… ë°°í¬ ì™„ë£Œ! 10ì´ˆ í›„ ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
            sleep 10
            sudo docker compose logs